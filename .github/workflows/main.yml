name: Summarize Code Changes (Windows, PowerShell, System Python 3.11)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  SUMMARY_DIR: ".changes"
  # Local Ollama endpoint on the self-hosted Windows runner
  OLLAMA_ENDPOINT: "http://localhost:11434"
  # You can override at runtime; a default is set later if empty
  OLLAMA_MODEL: "qwen2.5-coder:3b-instruct"

jobs:
  summarize:
    # Ensure your self-hosted Windows runner has the "self-hosted" label.
    # If you also added a "windows" label, you can use: runs-on: [self-hosted, windows]
    runs-on: self-hosted

    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

        # --- Make system Python 3.11 available to the job ---
      - name: Patch PATH for system Python 3.11
        id: patch_python
        run: |
          $pyHome = 'C:\Python311'          
          $pyExe  = Join-Path $pyHome 'python.exe'
          $pyScripts = Join-Path $pyHome 'Scripts'

          
          if (-not (Test-Path $pyExe)) {
              Write-Error "python.exe not found at: $pyExe"
              Write-Error "Install Python 3.11 is installed at C:\Python311."
              exit 1
            }

          # Patch PATH for subsequent steps in this job
          $newPath = "$pyHome;$pyScripts;$env:Path"
          "PATH=$newPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          # Emit for debugging
          "python_home=$pyHome" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "python_exe=$pyExe"   | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host "Patched PATH with: $pyHome and $pyScripts"

      - name: Verify system Python
        run: |
          python --version
          python -m pip --version
        
      - name: Print context
        run: |
          # PS5-compatible null/empty handling
          $oe = if ([string]::IsNullOrWhiteSpace($env:OLLAMA_ENDPOINT)) { '<empty>' } else { $env:OLLAMA_ENDPOINT }
          $om = if ([string]::IsNullOrWhiteSpace($env:OLLAMA_MODEL))    { '<empty>' } else { $env:OLLAMA_MODEL }
          Write-Host "Repository: ${{ github.repository }}"
          Write-Host "Branch:     ${{ github.ref_name }}"
          Write-Host "Before:     ${{ github.event.before }}"
          Write-Host "SHA:        ${{ github.sha }}"
          Write-Host "OLLAMA_ENDPOINT: $oe"
          Write-Host "OLLAMA_MODEL:    $om"

      - name: Compute diff
        id: diff
        run: |
          # Create diff.patch without failing the step if git diff errors/no changes
          try {
            git diff "${{ github.event.before }}..${{ github.sha }}" |
              Set-Content -Path diff.patch -NoNewline -ErrorAction Stop
          } catch {
            New-Item -ItemType File -Path diff.patch -Force | Out-Null
          }

          # Fast line count (wc -l equivalent)
          $lines = 0
          if (Test-Path diff.patch) {
            $lines = [System.IO.File]::ReadLines("diff.patch").Count
          }

          "lines=$lines"                  | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "sha=${{ github.sha }}"         | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "branch=${{ github.ref_name }}" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

          Write-Host "Diff lines: $lines"

          if ($lines -eq 0) {
            "NO_DIFF=1" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          }

      - name: Bail out if no diff
        if: ${{ env.NO_DIFF == '1' }}
        run: |
          Write-Host "No diff; nothing to summarize."
          exit 0
                 
      #- name: Install dependencies
      #  run: |
      #    python -m pip install --upgrade pip
      #    pip install unidiff requests

      - name: Ensure local Ollama is running (service or background)
        env:
          OLLAMA_ENDPOINT: ${{ env.OLLAMA_ENDPOINT }}
          OLLAMA_MODEL: ${{ env.OLLAMA_MODEL }}
        run: |
          # Prefer a Windows Service named 'Ollama' if present; else fall back to background 'ollama serve'
          $svc = Get-Service -Name "Ollama" -ErrorAction SilentlyContinue
          if ($null -ne $svc) {
            if ($svc.Status -ne 'Running') {
              Write-Host "Starting Ollama Windows service..."
              Start-Service -Name "Ollama"
            }
          } else {
            # No service: use ollama CLI in PATH
            if (-not (Get-Command ollama -ErrorAction SilentlyContinue)) {
              Write-Error "Ollama CLI not found in PATH. Install/configure Ollama on this runner or register its service."
              exit 1
            }
            Write-Host "Starting 'ollama serve' in background..."
            Start-Process -FilePath "ollama" -ArgumentList "serve" -WindowStyle Hidden | Out-Null
            Start-Sleep -Seconds 3
          }

          # Default model if not set
          if ([string]::IsNullOrWhiteSpace($env:OLLAMA_MODEL)) {
            $env:OLLAMA_MODEL = "qwen2.5-coder:3b-instruct"
          }

          # Try to detect if the model is present; pull if missing
          try {
            $resp = Invoke-WebRequest -Uri "$($env:OLLAMA_ENDPOINT)/api/tags" -UseBasicParsing -TimeoutSec 10
            $tags = $resp.Content | ConvertFrom-Json
          } catch {
            $tags = $null
          }
          if ($null -eq $tags -or -not ($tags.models.name -contains $env:OLLAMA_MODEL)) {
            Write-Host "Pulling model $env:OLLAMA_MODEL ..."
            ollama pull $env:OLLAMA_MODEL
          }

          # Health poll: wait until API is responsive
          $maxAttempts = 30
          $ok = $false
          for ($i = 1; $i -le $maxAttempts; $i++) {
            try {
              $ping = Invoke-WebRequest -Uri "$($env:OLLAMA_ENDPOINT)/api/tags" -UseBasicParsing -TimeoutSec 3
              if ($ping.StatusCode -ge 200 -and $ping.StatusCode -lt 300) { $ok = $true; break }
            } catch { }
            Start-Sleep -Seconds 2
          }
          if (-not $ok) {
            Write-Error "::error::Local Ollama not responding on $($env:OLLAMA_ENDPOINT)"
            exit 1
          }

      - name: Summarize via LOCAL Ollama
        env:
          OLLAMA_ENDPOINT: ${{ env.OLLAMA_ENDPOINT }}
          OLLAMA_MODEL: ${{ env.OLLAMA_MODEL }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:OLLAMA_MODEL)) {
            $env:OLLAMA_MODEL = "qwen2.5-coder:3b-instruct"
          }
          Write-Host "Using model: $env:OLLAMA_MODEL"

          python scripts/summarize_diff_ollama.py `
            --patch diff.patch `
            --repo "${{ github.repository }}" `
            --branch "${{ steps.diff.outputs.branch }}" `
            --sha "${{ steps.diff.outputs.sha }}" `
            --out summary.txt

      - name: Verify summary file
        run: |
          if (-not (Test-Path summary.txt) -or ((Get-Item summary.txt).Length -eq 0)) {
            Write-Error "summary.txt missing or empty"
            exit 1
          }
          # Show first 20 lines (head -n 20)
          Get-Content summary.txt -TotalCount 20 | ForEach-Object { Write-Host $_ }

      - name: Commit summary (direct push)
        run: |
          $summaryDir = $env:SUMMARY_DIR
          if ([string]::IsNullOrWhiteSpace($summaryDir)) { $summaryDir = ".changes" }

          New-Item -ItemType Directory -Path $summaryDir -Force | Out-Null
          Move-Item -Path "summary.txt" -Destination (Join-Path $summaryDir "${{ steps.diff.outputs.sha }}.txt") -Force

          git config --global user.name  "summary-bot"
          git config --global user.email "summary-bot@users.noreply.github.com"

          git add (Join-Path $summaryDir "${{ steps.diff.outputs.sha }}.txt")

          $pending = (git diff --cached --name-only)
          if ([string]::IsNullOrWhiteSpace($pending)) {
            Write-Host "Nothing to commit"
          } else {
            git commit -m "Add change summary for ${{ steps.diff.outputs.sha }}"
          }

          try {
            git push
          } catch {
            Write-Warning "Direct push failed (branch protection?). Throwing to enable PR fallback."
            throw
          }

      - name: Open PR (fallback)
        if: ${{ failure() }}
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Add change summary for ${{ steps.diff.outputs.sha }}"
          branch: "summary-bot/${{ steps.diff.outputs.sha }}"
          title: "Add summary for ${{ steps.diff.outputs.sha }}"
          body: "Automated summary created by Actions. Approve to merge."
          add-paths: |
            ${{ env.SUMMARY_DIR }}/${{ steps.diff.outputs.sha }}.txt
